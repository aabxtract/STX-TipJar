/**
 * This ruleset enforces a strict user-ownership model for the STX TipJar application.
 * All data is private and can only be accessed by the authenticated user who created it, with an exception for admins.
 *
 * Core Philosophy:
 * Users have complete control over their own data. Admins have read-only access to all user data for administrative purposes.
 * Access is granted based on the user's authentication UID matching the document path or having an admin claim.
 *
 * Data Structure:
 * - /users/{userId}: Stores the user's private profile document.
 * - /users/{userId}/tips/{tipId}: A subcollection storing all tips sent by that user.
 *
 * Key Security Decisions:
 * - Default Deny: All paths are closed by default. Access is only granted through explicit `allow` statements.
 * - Admin Read Access: Users with `isAdmin == true` on their profile can list all users.
 * - User Isolation: Non-admin users cannot list other users, preventing user enumeration.
 * - Path-Based Security: Authorization is determined by matching the authenticated user's ID (`request.auth.uid`) with the `{userId}` wildcard in the document path.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ------------------------------------------------------------------------
    // Helper Functions
    // ------------------------------------------------------------------------

    /**
     * Returns true if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Returns true if the authenticated user's UID matches the provided userId.
     * This is the core of the ownership-based security model.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    /**
     * Returns true if the requesting user is an admin.
     * Admins are identified by an `isAdmin` flag in their own user profile document.
     */
    function isAdmin() {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }


    /**
     * Returns true if the document exists and the user is the owner.
     * CRITICAL: Used for all update and delete operations to prevent acting on non-existent data.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * Validates required relational fields on User profile creation.
     * Enforces that the document's internal `id` field matches the document's ID (the user's UID).
     */
    function isValidUserProfileCreate(userId) {
      return request.resource.data.id == userId;
    }

    /**
     * Ensures critical relational fields in a User profile are not changed after creation.
     * Allows admins to change the isAdmin field.
     */
    function isImmutableUserProfile() {
        let isChangingAdminStatus = request.resource.data.isAdmin != resource.data.isAdmin;
        let coreFieldsUnchanged = request.resource.data.id == resource.data.id;
        
        // A regular user cannot change their admin status.
        if (isChangingAdminStatus && !isAdmin()) {
            return false;
        }

        return coreFieldsUnchanged;
    }

    /**
     * Validates required relational fields on Tip creation.
     * Enforces that the Tip's `senderId` matches the parent user's ID from the path.
     */
    function isValidTipCreate(userId) {
      return request.resource.data.senderId == userId;
    }

    /**
     * Ensures critical relational fields in a Tip document are not changed after creation.
     */
    function isImmutableTip() {
      return request.resource.data.senderId == resource.data.id;
    }

    // ------------------------------------------------------------------------
    // Collection Rules
    // ------------------------------------------------------------------------

    /**
     * @description Manages user profile documents. Each user has one document, identified by their UID.
     * @path /users/{userId}
     * @allow (get) A signed-in user accessing their own document, or an admin.
     * @allow (list) An admin listing all users.
     * @allow (create) A new user creating their profile document.
     * @allow (update, delete) A user modifying or deleting their own document. Admins can modify.
     * @deny (list) Non-admin users trying to list all documents in the `/users` collection.
     */
    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isAdmin();
      allow create: if isOwner(userId) && isValidUserProfileCreate(userId);
      allow update: if (isOwner(userId) || isAdmin()) && isImmutableUserProfile();
      allow delete: if isOwner(userId);
    }

    /**
     * @description Manages tip transactions sent by a specific user. Tips are stored in a subcollection under the sender's user profile.
     * @path /users/{userId}/tips/{tipId}
     * @allow (get, list) A user accessing their own tips, or an admin.
     * @allow (create) A user creating a new tip.
     * @allow (update, delete) A user modifying or deleting their own tip.
     */
    match /users/{userId}/tips/{tipId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isOwner(userId) || isAdmin();
      allow create: if isOwner(userId) && isValidTipCreate(userId);
      allow update: if isExistingOwner(userId) && isImmutableTip();
      allow delete: if isExistingOwner(userId);
    }
  }
}
