/**
 * This ruleset enforces a strict user-ownership model for the STX TipJar application.
 * All data is private and can only be accessed by the authenticated user who created it.
 *
 * Core Philosophy:
 * Users have complete control over their own data and no visibility into the data of other users.
 * Access is granted based on the user's authentication UID matching the document path.
 *
 * Data Structure:
 * All user-specific data is nested under the `/users/{userId}` path.
 * - `/users/{userId}`: Stores the user's private profile document.
 * - `/users/{userId}/tips/{tipId}`: A subcollection storing all tips sent by that user.
 *
 * Key Security Decisions:
 * - Default Deny: All paths are closed by default. Access is only granted through explicit `allow` statements.
 * - No Public Data: There are no publicly readable collections. All access requires authentication.
 * - User Isolation: Listing users is explicitly forbidden (`allow list: if false;` on the `/users` collection) to prevent user enumeration.
 * - Path-Based Security: Authorization is determined by matching the authenticated user's ID (`request.auth.uid`) with the `{userId}` wildcard in the document path.
 *
 * Denormalization for Authorization:
 * The `Tip` documents, located at `/users/{userId}/tips/{tipId}`, contain a `senderId` field.
 * This ruleset validates that on creation, the `senderId` in the document data matches the `{userId}` from the path.
 * This ensures data integrity and allows for simple, performant security rules without needing cross-document `get()` calls.
 *
 * Structural Segregation:
 * The primary security boundary is the top-level `/users` collection. By scoping all user data within a path dedicated to their UID (`/users/{userId}`), we ensure that a user can only query for and access their own information tree.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ------------------------------------------------------------------------
    // Helper Functions
    // ------------------------------------------------------------------------

    /**
     * Returns true if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Returns true if the authenticated user's UID matches the provided userId.
     * This is the core of the ownership-based security model.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Returns true if the document exists and the user is the owner.
     * CRITICAL: Used for all update and delete operations to prevent acting on non-existent data.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * Validates required relational fields on User profile creation.
     * Enforces that the document's internal `id` field matches the document's ID (the user's UID).
     */
    function isValidUserProfileCreate(userId) {
      return request.resource.data.id == userId;
    }

    /**
     * Ensures critical relational fields in a User profile are not changed after creation.
     */
    function isImmutableUserProfile() {
      return request.resource.data.id == resource.data.id;
    }

    /**
     * Validates required relational fields on Tip creation.
     * Enforces that the Tip's `senderId` matches the parent user's ID from the path.
     */
    function isValidTipCreate(userId) {
      return request.resource.data.senderId == userId;
    }

    /**
     * Ensures critical relational fields in a Tip document are not changed after creation.
     */
    function isImmutableTip() {
      return request.resource.data.senderId == resource.data.id;
    }

    // ------------------------------------------------------------------------
    // Collection Rules
    // ------------------------------------------------------------------------

    /**
     * @description Manages user profile documents. Each user has one document, identified by their UID.
     * @path /users/{userId}
     * @allow (get, update, delete) A signed-in user (auth.uid='user123') accessing their own document at `/users/user123`.
     * @allow (create) A new user (auth.uid='user123') creating their profile document for the first time at `/users/user123`.
     * @deny (any) Any user (auth.uid='userABC') trying to access another user's document at `/users/user123`.
     * @deny (list) Any user trying to list all documents in the `/users` collection. This prevents user enumeration.
     * @principle Restricts access to a user's own data tree and validates relational integrity.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && isValidUserProfileCreate(userId);
      allow update: if isExistingOwner(userId) && isImmutableUserProfile();
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Manages tip transactions sent by a specific user. Tips are stored in a subcollection under the sender's user profile.
     * @path /users/{userId}/tips/{tipId}
     * @allow (create) A signed-in user (auth.uid='user123') creating a new tip document at `/users/user123/tips/tipXYZ`.
     * @allow (get, list, update, delete) A signed-in user (auth.uid='user123') accessing their own tip documents within `/users/user123/tips`.
     * @deny (any) Any user (auth.uid='userABC') trying to access another user's tips at `/users/user123/tips/{tipId}`.
     * @principle Enforces document ownership for all operations within a user-specific subcollection.
     */
    match /users/{userId}/tips/{tipId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && isValidTipCreate(userId);
      allow update: if isExistingOwner(userId) && isImmutableTip();
      allow delete: if isExistingOwner(userId);
    }
  }
}